{% extends 'base_modern.html' %}
{% load humanize %}

{% block title %}Payroll - EONS HRM{% endblock %}
{% block header_title %}Payroll & Compliance{% endblock %}

{% block content %}
<div class="flex-1" style="width: 100%; display: flex; flex-direction: column;">
    <!-- Page Header & Action -->
    <div class="card-header-actions" style="align-items: flex-end;">
        <div>
            <h3 class="section-title">Payroll Management</h3>
            <p style="color: var(--gray-500); font-size: 0.875rem; margin-top: 4px;">
                Generate salary sheets and download Bank Transfer export files.
                <span style="font-size: 11px; margin-left: 8px; padding: 2px 6px; background: #dcfce7; color: #166534; border-radius: 4px; font-weight: 600;">Startup Model Active</span>
            </p>
        </div>

        <form method="POST" action="{% url 'run_payroll' %}" onsubmit="return confirm('Run payroll for selected month?');" style="margin: 0; display: flex; gap: 8px; align-items: center;">
            {% csrf_token %}
            <div style="display: flex; gap: 8px;">
                <select name="payroll_month_select" class="btn btn-outline" style="height: 44px; padding-left: 12px; border-color: var(--gray-300); cursor: pointer;" required>
                    <option value="" disabled>Select Month</option>
                    {% now "n" as current_month %}
                    <option value="1" {% if "1" == current_month %}selected{% endif %}>January</option>
                    <option value="2" {% if "2" == current_month %}selected{% endif %}>February</option>
                    <option value="3" {% if "3" == current_month %}selected{% endif %}>March</option>
                    <option value="4" {% if "4" == current_month %}selected{% endif %}>April</option>
                    <option value="5" {% if "5" == current_month %}selected{% endif %}>May</option>
                    <option value="6" {% if "6" == current_month %}selected{% endif %}>June</option>
                    <option value="7" {% if "7" == current_month %}selected{% endif %}>July</option>
                    <option value="8" {% if "8" == current_month %}selected{% endif %}>August</option>
                    <option value="9" {% if "9" == current_month %}selected{% endif %}>September</option>
                    <option value="10" {% if "10" == current_month %}selected{% endif %}>October</option>
                    <option value="11" {% if "11" == current_month %}selected{% endif %}>November</option>
                    <option value="12" {% if "12" == current_month %}selected{% endif %}>December</option>
                </select>
                <select name="payroll_year_select" class="btn btn-outline" style="height: 44px; padding-left: 12px; border-color: var(--gray-300); cursor: pointer;" required>
                    {% now "Y" as current_year %}
                    <option value="2024" {% if "2024" == current_year %}selected{% endif %}>2024</option>
                    <option value="2025" {% if "2025" == current_year %}selected{% endif %}>2025</option>
                    <option value="2026" {% if "2026" == current_year %}selected{% endif %}>2026</option>
                    <option value="2027" {% if "2027" == current_year %}selected{% endif %}>2027</option>
                    <option value="2028" {% if "2028" == current_year %}selected{% endif %}>2028</option>
                    <option value="2029" {% if "2029" == current_year %}selected{% endif %}>2029</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary" style="padding: 10px 24px; white-space: nowrap;">
                <i class="ri-flashlight-line"></i> Run Payroll
            </button>
        </form>
    </div>

    {% if messages %}
    <div style="margin-bottom: 24px;">
        {% for message in messages %}
        <div class="alert {% if message.tags == 'success' %}alert-success{% else %}alert-error{% endif %}" style="margin: 0;">
            <i class="ri-information-line"></i>
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Batches Grid -->
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 24px;">
        {% for batch in batches %}
        <div class="stat-card" style="padding: 24px; border-top: 4px solid var(--primary);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                <div>
                    <h4 style="font-size: 1.25rem; font-weight: 700; color: var(--gray-900); margin: 0;">{{ batch.month|date:"F Y" }}</h4>
                    <p style="font-size: 0.8125rem; color: var(--gray-500); margin-top: 4px;">Generated on {{ batch.generated_at|date:"M d, Y" }}</p>
                </div>
                <div style="width: 40px; height: 40px; background: rgba(37, 99, 235, 0.1); color: var(--primary); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px;">
                    <i class="ri-bank-card-line"></i>
                </div>
            </div>

            <div style="background: var(--gray-50); padding: 12px; border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 0.8125rem; color: var(--gray-600); font-weight: 500;">Batch Status</span>
                {% if batch.status == 'FINALIZED' %}
                <span class="badge badge-success">Generated</span>
                {% elif batch.status == 'VOID' %}
                <span class="badge" style="background: #f1f5f9; color: #64748b;">Voided</span>
                {% else %}
                <span class="badge" style="background: #fef3c7; color: #92400e;">Draft</span>
                {% endif %}
            </div>

            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <a href="{% url 'payroll_detail' batch.id %}" class="btn btn-primary" style="flex: 1; font-size: 13px; padding: 10px; min-width: 120px;">
                    <i class="ri-eye-line"></i> View Details
                </a>
                
                {% if batch.status == 'DRAFT' %}
                <form action="{% url 'payroll_batch_delete' batch.id %}" method="POST" onsubmit="return confirm('Delete this payroll draft for {{ batch.month|date:'F Y' }}?');">
                    {% csrf_token %}
                    <button type="submit" class="btn" style="background: #fff1f2; color: #e11d48; border: 1px solid #fee2e2; padding: 10px; border-radius: 8px;" title="Delete Draft">
                        <i class="ri-delete-bin-line"></i>
                    </button>
                </form>
                {% elif batch.status == 'VOID' %}
                <form action="{% url 'payroll_batch_delete' batch.id %}" method="POST" onsubmit="return confirm('Delete this voided payroll record for {{ batch.month|date:'F Y' }}? This cannot be undone.');">
                    {% csrf_token %}
                    <button type="submit" class="btn" style="background: #fff1f2; color: #e11d48; border: 1px solid #fee2e2; padding: 10px; border-radius: 8px; display: flex; align-items: center; gap: 6px;" title="Delete Record">
                        <i class="ri-delete-bin-line"></i> Delete
                    </button>
                </form>
                {% elif batch.status == 'FINALIZED' %}
                <form action="{% url 'payroll_batch_void' batch.id %}" method="POST" onsubmit="return confirm('Void this payroll batch? This will keep the record but mark it as invalid.')">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline" style="color: #64748b; padding: 10px; border-radius: 8px;" title="Void Batch">
                        <i class="ri-prohibit-line"></i> Void
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div style="grid-column: 1 / -1; text-align: center; padding: 80px 24px; background: var(--white); border-radius: var(--radius-lg); border: 1px solid var(--gray-200);">
            <div style="color: var(--gray-300); margin-bottom: 16px;">
                <i class="ri-history-line" style="font-size: 64px;"></i>
            </div>
            <h4 style="color: var(--gray-900); font-weight: 600;">No Payroll History</h4>
            <p style="color: var(--gray-500); font-size: 0.875rem;">Run your first payroll batch to see historical records here.</p>
        </div>
        {% endfor %}
    </div>
</div>

{% endblock %}